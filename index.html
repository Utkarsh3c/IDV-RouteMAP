<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Workout Heatmap (Year & Type Filter)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    html, body { margin:0; height:100%; }
    #map { position:absolute; top:0; bottom:0; width:100%; }

    /* Summary box */
    #summary {
      position:absolute; top:10px; left:10px;
      background:rgba(255,255,255,0.9);
      padding:8px 12px; font-family:sans-serif; font-size:13px;
      z-index:1000; border-radius:4px;
      box-shadow:0 1px 4px rgba(0,0,0,0.3);
      max-width:200px;
    }
    #summary strong { display:block; margin-bottom:4px; }

    /* Filters */
    #filter-controls {
      position:absolute; top:10px; right:10px;
      background:rgba(255,255,255,0.9);
      padding:6px 10px; font-family:sans-serif; font-size:13px;
      z-index:1000; border-radius:4px; box-shadow:0 1px 4px rgba(0,0,0,0.3);
      display:flex; gap:8px; align-items:center;
    }
    #filter-controls label { margin-right:4px; }

    /* Slide-out panel */
    #panel {
      position:absolute; top:0; right:-320px;
      width:320px; height:100%; background:#fff;
      box-shadow:-2px 0 8px rgba(0,0,0,0.15);
      transition:right 0.3s; overflow-y:auto; font-family:sans-serif;
      z-index:1000;
    }
    #panel.open { right:0; }
    #panel header {
      position:sticky; top:0; background:#f7f7f7;
      padding:1rem; border-bottom:1px solid #ddd;
    }
    #panel header .close {
      position:absolute; top:1rem; right:1rem; cursor:pointer;
      font-size:1.2rem;
    }
    .activity-item {
      padding:.75rem 1rem; border-bottom:1px solid #eee;
      cursor:pointer;
    }
    .activity-item h3 { margin:0 0 .25rem; font-size:1rem; }
    .activity-item p  { margin:0; font-size:.9rem; color:#555; }

    /* Detail buttons */
    .detail-buttons {
      display:flex; gap:8px; padding:1rem;
    }
    .detail-buttons button {
      flex:1; padding:.5rem; border:none; border-radius:4px;
      cursor:pointer; font-size:.9rem;
    }
    .detail-buttons .btn-back { background:#ccc; }
    .detail-buttons .btn-show-all {
      background:#007bff; color:#fff;
    }
    .detail-buttons .btn-show-all:hover { background:#0056b3; }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Summary -->
  <div id="summary">
    <strong>Summary</strong>
    <div id="summary-total"></div>
    <div id="summary-per-year" style="margin-top:6px;"></div>
  </div>

  <!-- Filters -->
  <div id="filter-controls">
    <label for="year-select">Year:</label>
    <select id="year-select"><option value="all">All</option></select>
    <label for="type-select">Type:</label>
    <select id="type-select">
      <option value="all">All</option>
      <option value="Running">Running</option>
      <option value="Biking">Biking</option>
    </select>
  </div>

  <!-- Panel -->
  <div id="panel">
    <header>
      <h2>Segment Activities</h2>
      <span class="close" onclick="showAllRoutes()">✕</span>
    </header>
    <div id="activity-list"></div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

  <script>
    let allRoutes, indexData, segmentsLayer, map, initialBounds;
    let currentActivities = [];
    const yearSel = document.getElementById('year-select'),
          typeSel = document.getElementById('type-select');

    function updateSummary(metaArray) {
      const totalCount = metaArray.length;
      const totalKm    = (metaArray.reduce((sum,a)=>sum+(a.distance_m||0),0)/1000).toFixed(1);
      document.getElementById('summary-total').innerHTML = 
        `${totalCount} activities<br/>${totalKm} km`;
      const perYear = {};
      metaArray.forEach(a=>{
        const y = new Date(a.start_time).getFullYear();
        perYear[y] = perYear[y]||{count:0,dist:0};
        perYear[y].count++;
        perYear[y].dist += (a.distance_m||0);
      });
      document.getElementById('summary-per-year').innerHTML =
        Object.entries(perYear)
          .sort((a,b)=>b[0]-a[0])
          .map(([y,s])=>`${y}: ${s.count} ▪ ${(s.dist/1000).toFixed(1)} km`)
          .join('<br/>');
    }

    function styleBySport(feature) {
      const m = indexData.find(a=>a.activityId===feature.properties.activityId)||{};
      if (m.sport==='Biking')  return {color:'#e31a1c', weight:4, opacity:0.8};
      if (m.sport==='Running') return {color:'#1f78b4', weight:4, opacity:0.8};
      return {color:'#888', weight:4, opacity:0.8};
    }

    function applyFilters() {
      const yr   = yearSel.value;
      const type = typeSel.value;
      const visible = indexData.filter(a=>{
        if (yr!=='all'   && new Date(a.start_time).getFullYear().toString()!==yr) return false;
        if (type!=='all' && a.sport!==type) return false;
        return true;
      });
      updateSummary(visible);

      segmentsLayer.clearLayers();
      // draw in chronological order
      visible.sort((a,b)=>new Date(a.start_time)-new Date(b.start_time))
             .forEach(a=>{
        const f = allRoutes.features.find(f=>f.properties.activityId===a.activityId);
        if (f) segmentsLayer.addData(f);
      });
      map.fitBounds( segmentsLayer.getBounds(), {padding:[20,20]} );
    }

    Promise.all([
      fetch('segments.geojson').then(r=>r.json()),
      fetch('activity_index.json').then(r=>r.json())
    ]).then(([routes,idx])=>{
      allRoutes = routes;
      indexData = idx;

      // populate year dropdown
      const years = [...new Set(indexData.map(a=>new Date(a.start_time).getFullYear()))].sort();
      years.forEach(y=>{
        const o = document.createElement('option');
        o.value = y; o.textContent = y;
        yearSel.appendChild(o);
      });

      // init map
      map = L.map('map').setView([1.35,103.82],12);
      L.tileLayer(
        'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
        { attribution:'© OSM © CARTO', subdomains:'abcd', maxZoom:19 }
      ).addTo(map);

      segmentsLayer = L.geoJSON([], {style:styleBySport}).addTo(map);
      initialBounds = map.getBounds();

      // hook filters
      yearSel.addEventListener('change', applyFilters);
      typeSel.addEventListener('change', applyFilters);

      // initial draw
      applyFilters();

      // proximity-click to list
      map.on('click', e=>{
        const pt  = turf.point([e.latlng.lng,e.latlng.lat]);
        const buf = turf.buffer(pt,15,{units:'meters'});
        const ids = [...new Set(
          allRoutes.features
            .filter(f=> turf.booleanIntersects(buf, turf.lineString(f.geometry.coordinates)))
            .map(f=>f.properties.activityId)
        )];
        if (ids.length) {
          const acts = ids.map(i=>indexData.find(a=>a.activityId===i)).filter(a=>a);
          showActivitiesList(acts);
        }
      });
    }).catch(console.error);

    // slide-out panel functions
    function togglePanel(open){
      document.getElementById('panel').classList.toggle('open', open);
    }
    function showActivitiesList(list){
      currentActivities = list;
      const c = document.getElementById('activity-list');
      c.innerHTML = '';
      list.forEach(a=>{
        const date = new Date(a.start_time).toLocaleDateString();
        const km   = (a.distance_m/1000).toFixed(1);
        const div = document.createElement('div');
        div.className = 'activity-item';
        div.innerHTML = `<h3>${date} — ${a.sport}</h3>
                         <p>Dist: ${km} km · Dur: ${Math.floor(a.duration_s/60)}m</p>`;
        div.onclick = ()=> showActivityDetails(a.activityId);
        c.appendChild(div);
      });
      togglePanel(true);
    }
    function showActivityDetails(id){
      const feat = allRoutes.features.find(f=>f.properties.activityId===id),
            act  = indexData.find(a=>a.activityId===id);
      if (!feat || !act) return;

      segmentsLayer.clearLayers();
      segmentsLayer.addData(feat);
      map.fitBounds( L.geoJSON(feat).getBounds(), {padding:[20,20]} );

      const c = document.getElementById('activity-list');
      c.innerHTML = `
        <div class="activity-item">
          <h3>${new Date(act.start_time).toLocaleString()}</h3>
          <p><strong>Sport:</strong> ${act.sport}</p>
          <p><strong>Distance:</strong> ${(act.distance_m/1000).toFixed(1)} km</p>
          <p><strong>Duration:</strong> ${Math.floor(act.duration_s/60)}m ${Math.round(act.duration_s%60)}s</p>
        </div>
        <div class="detail-buttons">
          <button class="btn-back" id="back-btn">← Back</button>
          <button class="btn-show-all" id="show-all-btn">Show All</button>
        </div>`;
      document.getElementById('back-btn').onclick     = () => showActivitiesList(currentActivities);
      document.getElementById('show-all-btn').onclick = () => { applyFilters(); togglePanel(false); };
    }
    function showAllRoutes(){
      applyFilters();
      togglePanel(false);
    }
  </script>
</body>
</html>
